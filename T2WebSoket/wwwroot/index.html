<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.19/signalr.min.js"></script>
</head>
<body>
    <div>
        <label>User ID:</label>
        <input type="text" id="userId" />
        <button onclick="loadChats()">Load Chats</button>
    </div>
    <div id="chats"></div>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message" />
    <input type="button" id="sendBtn" value="Otpravit"/>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        let currentChatId = null; // Переменная для хранения текущего chatId

        document.getElementById("sendBtn").addEventListener("click", function () {
            sendMessage();
        })



        connection.on("ReceiveMessage", (userName, message, timestamp, mediaUrl) => {
            const messagesDiv = document.getElementById("messages");
            const messageElement = document.createElement("div");
            messageElement.textContent = `${userName} (${new Date(timestamp).toLocaleTimeString()}): ${message}`;
            messagesDiv.appendChild(messageElement);
        });

        async function loadChats() {
            const userId = document.getElementById("userId").value;
            const response = await fetch(`/api/chat/${userId}`);
            const chats = await response.json();

            const chatsDiv = document.getElementById("chats");
            chatsDiv.innerHTML = "";
            chats.forEach(chat => {
                const chatButton = document.createElement("button");
                chatButton.textContent = chat.name;
                chatButton.onclick = () => joinChat(chat.id);
                chatsDiv.appendChild(chatButton);
            });
        }

        async function joinChat(chatId) {
            console.log(`connected to chat ${chatId}`)
            currentChatId = chatId; // Сохраняем текущий chatId
            try {
                if (connection.state === signalR.HubConnectionState.Disconnected) {
                    await connection.start();
                }
                await connection.invoke("JoinGroup", currentChatId);
                // Load existing messages for the chat

                const chatHistory = await connection.invoke("GetChatHistory", chatId);
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML = "";
                chatHistory.forEach(message => {
                    const messageElement = document.createElement("div");
                    messageElement.textContent = `${message.userName} (${new Date(message.creationDate).toLocaleTimeString()}): ${message.body}`;
                    messagesDiv.appendChild(messageElement);
                });
            } catch (err) {
                console.error("Error joining chat:", err);
            }
        }

        async function sendMessage() {
            console.log("sendMessage called");
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;
            const userId = document.getElementById("userId").value;

            if (!currentChatId) {
                alert("Please select a chat first.");
                return;
            }
            console.log("Sending message:", { userId, message, currentChatId });


            try {
                console.log("Connection state before sending message:", connection.state);
                if (connection.state === signalR.HubConnectionState.Disconnected) {
                    await connection.start();
                }
                console.log("Sending message:", { userId, message, currentChatId });
                await connection.invoke("Send", userId, message, currentChatId)
                    .catch(function (err) {
                        return console.error(err.toString());
                    });
                messageInput.value = "";
            } catch (err) {
                console.error("Error sending message:", err);
                alert("Failed to send message. Please check the console for more details.");
            }
        }

        // Start the connection when the page loads
        connection.start().catch(err => console.error("Error connecting to chat hub:", err));
    </script>
</body>
</html>
